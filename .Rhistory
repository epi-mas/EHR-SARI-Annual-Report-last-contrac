}
# Identify available positivity columns
positivity_vars <- intersect(c("sc2_pos_total", "flu_pos_total", "rsv_pos_total"), colnames(df))
# Set country-specific title with country names
plot_title <- case_when(
country == "AU" ~ "SARI Hospitalisations in Austria",
country == "BE" ~ "SARI Hospitalisations in Belgium",
country == "DE" ~ "SARI Hospitalisations in Germany",
country == "MT" ~ "SARI Hospitalisations in Malta",
country == "LU" ~ "SARI Hospitalisations in Luxembourg",
country == "EE_rates" ~ "SARI admission per 100.000 population in Estonia",
country == "IS_rates" ~ "SARI admission per 100.000 population and test positivity in Iceland",
TRUE ~ paste("SARI hospitalisation and test positivity in", country_names[[country]])
)
# Define legend label for grey bars
bar_legend_label <- ifelse(country %in% c("EE_rates", "IS_rates"),
"Weekly SARI rate",
"Weekly SARI hospitalisations")
# Find the epidemiological week for 2024-W40 (for the vertical dashed line)
epi_week_2024W40 <- which(df$week == "2024-W40")
# Create the base plot with hospitalization bars (grey color with legend)
plot <- ggplot(df, aes(x = week)) +
geom_bar(aes(y = .data[[hospitalization_var]], fill = bar_legend_label),
stat = "identity", alpha = 0.7) +
scale_fill_manual(values = c("grey")) + # Set grey color for bars
scale_y_continuous(
name = ifelse(country %in% c("EE_rates", "IS_rates"),
"SARI Admissions per 100.000 Population",
"SARI Hospitalisations")
) +
labs(
title = plot_title,
subtitle = "2023-W40 to 2024-W52",
x = "Epidemiological Week",
y = ifelse(country %in% c("EE_rates", "IS_rates"),
"SARI Admissions per 100.000 Population",
"SARI Hospitalisations"),
fill = ""  # Hide legend title
) +
theme_minimal(base_size = 14) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(color = "#2B83BA", face = "bold", size = 16),
plot.subtitle = element_text(color = "gray50", face = "italic", size = 12),
legend.position = "bottom",
panel.background = element_rect(fill = "white", color = "white"),
plot.background = element_rect(fill = "white", color = "white")
) +
scale_x_discrete(breaks = every_nth(df$week, 2))  # Show more weeks (every other week)
# Add positivity rates if available
if (length(positivity_vars) > 0) {
# Pivot to long format
df_long <- df %>%
select(week, all_of(positivity_vars)) %>%
pivot_longer(cols = all_of(positivity_vars), names_to = "positivity_type", values_to = "positivity_value")
# Normalize positivity values to match hospitalization scale
max_hospitalizations <- max(df[[hospitalization_var]], na.rm = TRUE)
# Rename positivity variables for the legend
df_long$positivity_type <- factor(df_long$positivity_type,
levels = names(positivity_legend_labels),
labels = positivity_legend_labels[names(positivity_legend_labels) %in% df_long$positivity_type])
plot <- plot +
geom_line(data = df_long, aes(x = week,
y = positivity_value * max_hospitalizations / 100,
color = positivity_type,
group = positivity_type), linewidth = 1) +
scale_y_continuous(
name = ifelse(country %in% c("EE_rates", "IS_rates"),
"SARI Admissions per 100.000 Population",
"SARI Hospitalisations"),
sec.axis = sec_axis(~ . * 100 / max_hospitalizations,
name = "Test Positivity (%)",
labels = function(x) round(x))  # Round right Y-axis values
) +
scale_color_manual(
name = NULL,  # Removes "positivity type" text from legend
values = c("SARS-CoV-2 positivity" = "#E41A1C",
"Influenza virus positivity" = "#377EB8",
"RSV positivity" = "#E69F00")  # RSV is now orange
)
}
# Add vertical dashed line for all countries + season labels
plot <- plot +
geom_vline(xintercept = epi_week_2024W40,
linetype = "dashed", linewidth = 0.5, color = "black") +
annotate("text", x = epi_week_2024W40 - 3, y = max(df[[hospitalization_var]], na.rm = TRUE) * 0.9,
label = "2023/24 season", size = 3, color = "black", fontface = "plain", hjust = 1) +
annotate("text", x = epi_week_2024W40 + 3, y = max(df[[hospitalization_var]], na.rm = TRUE) * 0.9,
label = "2024/25 season", size = 3, color = "black", fontface = "plain", hjust = 0)
# Save plot
file_path <- paste0("FIGURES/SARI_plot_", country, "_", Sys.Date(), ".png")
ggsave(file_path, plot, width = 10, height = 6, dpi = 800, bg = "white")
print(paste("Plot saved:", file_path))
}
# Set package requirements, file paths etc
source("config.R")
country_codes <- c("IS_rates") #c("AU", "BE", "DE", "EE_rates", "IS_rates", "LU", "MT")
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import_epi_data.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- c("AU", "BE", "DE", "EE_rates", "IS_rates", "LU", "MT")
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import_epi_data.R")
#define study peirod from week_from to week_to
source("scripts/period.R")
source("scripts/merge.R")
source("scripts/country_plot.R")
View(BE_total)
View(EE_rates_total)
View(AU_counts)
str(BE_counts)
str(EE_rates_counts)
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
View(BE_rates)
#define study period from week_from to week_to
source("scripts/period.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos_BE.R") # BE provided sari counts, not rates.
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos_BE.R") # BE provided sari counts, not rates.
# Add positivity rates if available
if (length(positivity_data) > 0) {
df <- df %>%
# Convert all positivity columns to numeric safely
mutate(across(all_of(names(positivity_data)), ~ suppressWarnings(as.numeric(.))))
df_long <- df %>%
select(week, all_of(names(positivity_data))) %>%
pivot_longer(
cols = names(positivity_data),
names_to = "positivity_type",
values_to = "positivity_value"
)
# Ensure positivity_type matches the legend mapping
df_long$positivity_type <- factor(
df_long$positivity_type,
levels = names(positivity_legend_labels),
labels = positivity_legend_labels[names(positivity_legend_labels) %in% df_long$positivity_type]
)
plot <- plot +
geom_line(data = df_long, aes(x = week, y = positivity_value * max(df[[hospitalization_var]], na.rm = TRUE) / 100,
color = positivity_type, group = positivity_type), linewidth = 1) +
scale_color_manual(
name = NULL,
values = c("SARS-CoV-2 positivity" = "#E41A1C",
"Influenza virus positivity" = "#377EB8",
"RSV positivity" = "#E69F00")
)
}
# Save plot
file_path <- paste0("FIGURES/SARI_plot_", country, "_", Sys.Date(), ".png")
ggsave(file_path, plot, width = 10, height = 6, dpi = 800, bg = "white")
print(paste("Plot saved:", file_path))
}
library(ggplot2)
library(dplyr)
library(tidyr)
# Function to reduce x-axis labels for better readability (show every other week)
every_nth <- function(x, n) {
x[seq(1, length(x), by = n)]
}
# Country name mapping
country_names <- c(
"DE" = "Germany", "LU" = "Luxembourg", "MT" = "Malta",
"EE" = "Estonia", "IS" = "Iceland",
"AU" = "Austria", "BE" = "Belgium"
)
# Positivity variable renaming for legend
positivity_legend_labels <- c(
"sc2_pos_total" = "SARS-CoV-2 positivity",
"flu_pos_total" = "Influenza virus positivity",
"rsv_pos_total" = "RSV positivity"
)
# List of country codes
country_codes <- names(country_names)
for (country in country_codes) {
# Check for available hospitalization dataframe
df_rates_name <- paste0(country, "_rates")
df_counts_name <- paste0(country, "_counts")
if (exists(df_rates_name, envir = .GlobalEnv)) {
df <- get(df_rates_name, envir = .GlobalEnv)
hospitalization_var <- "saricaserate_total"
y_label <- "SARI Admissions per 100.000 Population"
} else if (exists(df_counts_name, envir = .GlobalEnv)) {
df <- get(df_counts_name, envir = .GlobalEnv)
hospitalization_var <- "sari_case_total"
y_label <- "SARI Hospitalisations"
} else {
print(paste("Skipping", country, "- No hospitalization data available"))
next
}
# Ensure the hospitalization column exists
if (!(hospitalization_var %in% colnames(df))) {
print(paste("Skipping", country, "- Hospitalization variable missing"))
next
}
# Identify available positivity data
positivity_dfs <- list(
"sc2_pos_total" = paste0(country, "_Positivity_SARS-CoV-2"),
"flu_pos_total" = paste0(country, "_Positivity_Influenza"),
"rsv_pos_total" = paste0(country, "_Positivity_RSV")
)
positivity_data <- list()
for (var in names(positivity_dfs)) {
df_name <- positivity_dfs[[var]]
if (exists(df_name, envir = .GlobalEnv)) {
df_pos <- get(df_name, envir = .GlobalEnv)
if (var %in% colnames(df_pos)) {
positivity_data[[var]] <- df_pos[, c("week", var)]
}
}
}
# Merge positivity data
if (length(positivity_data) > 0) {
positivity_df <- Reduce(function(x, y) full_join(x, y, by = "week"), positivity_data)
df <- left_join(df, positivity_df, by = "week")
}
# Set plot title
plot_title <- paste("SARI Hospitalisations and Test Positivity in", country_names[[country]])
# Create the base plot
plot <- ggplot(df, aes(x = week)) +
geom_bar(aes(y = .data[[hospitalization_var]], fill = "SARI Cases"),
stat = "identity", alpha = 0.7, fill = "grey") +
scale_y_continuous(
name = y_label,
sec.axis = sec_axis(~ . * 100 / max(df[[hospitalization_var]], na.rm = TRUE),
name = "Test Positivity (%)", labels = function(x) round(x))
) +
labs(
title = plot_title,
x = "Epidemiological Week",
fill = ""
) +
theme_minimal(base_size = 14) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(face = "bold", size = 16),
legend.position = "bottom"
) +
scale_x_discrete(breaks = every_nth(df$week, 2))
# Add positivity rates if available
if (length(positivity_data) > 0) {
df_long <- df %>%
select(week, all_of(names(positivity_data))) %>%
pivot_longer(cols = names(positivity_data), names_to = "positivity_type", values_to = "positivity_value")
df_long$positivity_type <- factor(df_long$positivity_type,
levels = names(positivity_legend_labels),
labels = positivity_legend_labels[names(positivity_legend_labels) %in% df_long$positivity_type])
plot <- plot +
geom_line(data = df_long, aes(x = week, y = positivity_value * max(df[[hospitalization_var]], na.rm = TRUE) / 100,
color = positivity_type, group = positivity_type), linewidth = 1) +
scale_color_manual(
name = NULL,
values = c("SARS-CoV-2 positivity" = "#E41A1C",
"Influenza virus positivity" = "#377EB8",
"RSV positivity" = "#E69F00")
)
}
# Save plot
file_path <- paste0("FIGURES/SARI_plot_", country, "_", Sys.Date(), ".png")
ggsave(file_path, plot, width = 10, height = 6, dpi = 800, bg = "white")
print(paste("Plot saved:", file_path))
}
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- "BE" #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_age_sari_pos.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <- "c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
# Set package requirements, file paths etc
source("config.R")
country_codes <- "c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
# Set package requirements, file paths etc
source("config.R")
country_codes <- c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos.R")
source("scripts/visualise/plot_age_sari_pos.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <-  c("LU") #c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
# Set package requirements, file paths etc
source("config.R")
country_codes <-  c("DK", "AU", "BE", "DE", "EE", "IS", "LU", "MT") # for BE rates are not available. For LU rates are only avialable for totals.
#define cutoffs
week_from <- "2023-W40"
week_to <- "2024_W52"
source("scripts/import.R")
View(LU_rates)
#define study period from week_from to week_to
source("scripts/period.R")
source("scripts/visualise/plot_sari_hosp_pos_LU.R") # overall SARI admissions and test positivity for LU where only SARS-CoV_2 positivity is available.
View(LU_rates)
library(ggplot2)
library(dplyr)
library(tidyr)
# Define colors
sari_color <- "grey"  # Color for SARI Cases
sars_cov2_color <- "#E41A1C"  # Red for SARS-CoV-2 positivity
# Load hospitalization data
df <- LU_rates
# Define the hospitalization variable
hospitalization_var <- "saricase_total"  # Use the correct column name
y_label <- "SARI Admissions"
# Load positivity data
if (exists("LU_Positivity_SARS-CoV-2", envir = .GlobalEnv)) {
df_pos <- get("LU_Positivity_SARS-CoV-2", envir = .GlobalEnv)
# Ensure numeric values
df_pos <- df_pos %>%
mutate(across("sc2_pos_total", as.numeric)) %>%
select(week, sc2_pos_total)
# Merge with hospitalization data
df <- left_join(df, df_pos, by = "week")
}
# Set plot title
plot_title <- "SARI Hospitalisations and SARS-CoV-2 Positivity in Luxembourg"
# Create the base plot
plot <- ggplot(df, aes(x = week)) +
geom_bar(aes(y = .data[[hospitalization_var]], fill = "SARI Cases"),
stat = "identity", alpha = 0.7) +
scale_fill_manual(values = c("SARI Cases" = sari_color)) +
scale_y_continuous(
name = y_label,
sec.axis = sec_axis(~ . * 100 / max(df[[hospitalization_var]], na.rm = TRUE),
name = "Test Positivity (%)", labels = function(x) round(x))
) +
labs(
title = plot_title,
x = "Epidemiological Week",
fill = NULL
) +
theme_minimal(base_size = 14) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(face = "bold", size = 16),
legend.position = "bottom"
)
# Add SARS-CoV-2 positivity if available
if ("sc2_pos_total" %in% colnames(df)) {
plot <- plot +
geom_line(aes(x = week, y = sc2_pos_total * max(df[[hospitalization_var]], na.rm = TRUE) / 100,
color = "SARS-CoV-2 positivity", group = 1), linewidth = 1) +
scale_color_manual(values = c("SARS-CoV-2 positivity" = sars_cov2_color))
}
# Ensure the "FIGURES" directory exists
output_dir <- "FIGURES"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
# Save plot
file_path <- file.path(output_dir, paste0("SARI_plot_LU_", Sys.Date(), ".png"))
ggsave(file_path, plot, width = 10, height = 6, dpi = 800, bg = "white")
print(paste("Plot saved:", file_path))
View(LU_rates)
# LU
library(ggplot2)
library(dplyr)
library(tidyr)
# Function to reduce x-axis labels for better readability (show every other week)
every_nth <- function(x, n) {
x[seq(1, length(x), by = n)]
}
# Define colors
sari_color <- "grey"  # Color for SARI Cases
sars_cov2_color <- "#E41A1C"  # Red for SARS-CoV-2 positivity
# Load hospitalization data
df <- LU_rates
# Define the hospitalization variable
hospitalization_var <- "saricase_total"  # Use the correct column name
y_label <- "SARI Admissions"
# Load positivity data
if (exists("LU_Positivity_SARS-CoV-2", envir = .GlobalEnv)) {
df_pos <- get("LU_Positivity_SARS-CoV-2", envir = .GlobalEnv)
# Ensure numeric values
df_pos <- df_pos %>%
mutate(across("sc2_pos_total", as.numeric)) %>%
select(week, sc2_pos_total)
# Merge with hospitalization data
df <- left_join(df, df_pos, by = "week")
}
# Set plot title
plot_title <- "SARI Hospitalisations and SARS-CoV-2 Positivity in Luxembourg"
# Create the base plot
plot <- ggplot(df, aes(x = week)) +
geom_bar(aes(y = .data[[hospitalization_var]], fill = "SARI Cases"),
stat = "identity", alpha = 0.7) +
scale_fill_manual(values = c("SARI Cases" = sari_color)) +
scale_y_continuous(
name = y_label,
sec.axis = sec_axis(~ . * 100 / max(df[[hospitalization_var]], na.rm = TRUE),
name = "Test Positivity (%)", labels = function(x) round(x))
) +
labs(
title = plot_title,
x = "Epidemiological Week",
fill = NULL
) +
theme_minimal(base_size = 14) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(face = "bold", size = 16),
legend.position = "bottom"
) +
scale_x_discrete(breaks = every_nth(df$week, 2))  # Reduce x-axis label density
# Add SARS-CoV-2 positivity if available
if ("sc2_pos_total" %in% colnames(df)) {
plot <- plot +
geom_line(aes(x = week, y = sc2_pos_total * max(df[[hospitalization_var]], na.rm = TRUE) / 100,
color = "SARS-CoV-2 positivity", group = 1), linewidth = 1) +
scale_color_manual(values = c("SARS-CoV-2 positivity" = sars_cov2_color))
}
# Ensure the "FIGURES" directory exists
output_dir <- "FIGURES"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
# Save plot
file_path <- file.path(output_dir, paste0("SARI_plot_LU_", Sys.Date(), ".png"))
ggsave(file_path, plot, width = 10, height = 6, dpi = 800, bg = "white")
print(paste("Plot saved:", file_path))
